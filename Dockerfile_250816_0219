# ======================
# ğŸ”µ 1. FRONTEND ë¹Œë“œ ë‹¨ê³„
# ======================
FROM node:18 AS frontend

WORKDIR /app
# package.jsonê³¼ package-lock.jsonì„ ëª¨ë‘ ë³µì‚¬
# COPY package.json package-lock.json ./
COPY hearth_chat_react/package.json hearth_chat_react/package-lock.json ./
RUN npm install

COPY hearth_chat_react/ ./
# ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •ìœ¼ë¡œ ë¹Œë“œ ì•ˆì •ì„± í–¥ìƒ
ENV NODE_OPTIONS="--max-old-space-size=4096"
RUN npm run build

# ì†ŒìŠ¤ë§µ íŒŒì¼ ì‚­ì œ (Docker ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”)
RUN find /app/build -type f -name "*.map" -delete

RUN ls -la /app/build/ || echo "build directory not found"
RUN ls -la /app/build/static/ || echo "static directory not found"
RUN ls -la /app/build/static/js/ || echo "static/js directory not found"
RUN ls -la /app/build/avatar_vrm/ || echo "avatar_vrm directory not found"

# ======================
# ğŸŸ¡ 2. BACKEND (Django)
# ======================
FROM python:3.11.5-slim

# ì‹œìŠ¤í…œ í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (pkg-config ì¶”ê°€)
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    pkg-config \
    default-libmysqlclient-dev \
    postgresql-client \
    # Pillow ì˜ì¡´ì„±
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt ./
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ğŸ” í”„ë¡ íŠ¸ ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=frontend /app/build/ /app/hearth_chat_react/build/
RUN ls -la /app/hearth_chat_react/build/ || echo "build directory not found"
RUN ls -la /app/hearth_chat_react/build/static/ || echo "static directory not found"
RUN ls -la /app/hearth_chat_react/build/static/js/ || echo "static/js directory not found"

# ì¥ê³  ì•± ë³µì‚¬ (ì´í›„ì—ë§Œ ì»¤ìŠ¤í…€ ì»¤ë§¨ë“œ ì‹¤í–‰ ê°€ëŠ¥)
COPY hearth_chat_django/ ./hearth_chat_django/

# React ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ (ì´ë¯¸ ìˆìŒ)
COPY --from=frontend /app/build/ /app/hearth_chat_react/build/

# collectstaticì€ ëŸ°íƒ€ì„ì— ì‹¤í–‰í•˜ë„ë¡ ì œê±° (ë¹Œë“œ ì‹œì ì—ëŠ” ë¶ˆí•„ìš”)
# ENV DATABASE_URL=sqlite:///tmp/db.sqlite3
# WORKDIR /app/hearth_chat_django
# RUN python manage.py collectstatic --noinput || echo "collectstatic failed, continuing..."

# ë°˜ë“œì‹œ ì¥ê³  ì•± ë³µì‚¬ ì´í›„ì— ìŠˆí¼ìœ ì € ìë™ ìƒì„± (ë¹Œë“œ íƒ€ì„ì— ì‹¤í–‰)
RUN python manage.py createinitialsuperuser || echo "Superuser creation skipped during build"

# ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ Django ì•±ìœ¼ë¡œ ë³€ê²½
WORKDIR /app/hearth_chat_django

# ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
COPY script/dh.sh /usr/local/bin/dh
COPY script/rh.sh /usr/local/bin/rh
COPY script/cs.sh /usr/local/bin/cs
RUN chmod +x /usr/local/bin/dh /usr/local/bin/rh /usr/local/bin/cs

# start.sh ë³µì‚¬ ë° ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
COPY hearth_chat_django/script/start.sh /usr/local/bin/start.sh
RUN chmod +x /usr/local/bin/start.sh

# entrypoint.sh ë³µì‚¬ ë° ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
COPY hearth_chat_django/script/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8080

# Railwayì—ì„œ entrypoint.shê°€ ì‹¤í–‰ë˜ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
ENTRYPOINT ["/entrypoint.sh"]

# ë¯¸ë””ì–´ íŒŒì¼ ë³µì‚¬
# COPY hearth_chat_media/avatar_vrm_test/test.vrm ./hearth_chat_media/avatar_vrm_test/test.vrmOPY hearth_chat_media/avatar_vrm_test/test.vrm ./hearth_chat_media/avatar_vrm_test/test.vrmOPY hearth_chat_media/avatar_vrm_test/test.vrm ./hearth_chat_media/avatar_vrm_test/test.vrmOPY hearth_chat_media/avatar_vrm_test/test.vrm ./hearth_chat_media/avatar_vrm_test/test.vrmOPY hearth_chat_media/avatar_vrm_test/test.vrm ./hearth_chat_media/avatar_vrm_test/test.vrm