name: Manual Deploy to Render

on:
  # ìë™ íŠ¸ë¦¬ê±° ë¹„í™œì„±í™”
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë§Œ í™œì„±í™”
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check project structure
      run: |
        echo "ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸"
        echo "======================"
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo ""
        echo "ğŸ“‚ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -la
        echo ""
        echo "ğŸ“‚ hearth_chat_django ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -la hearth_chat_django/
        echo ""
        echo "ğŸ“‚ hearth_chat_react ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -la hearth_chat_react/
        echo ""
        echo "ğŸ“„ requirements.txt íŒŒì¼ í™•ì¸:"
        if [ -f "requirements.txt" ]; then
          echo "âœ… ë£¨íŠ¸ì— requirements.txt ì¡´ì¬"
          echo "íŒŒì¼ í¬ê¸°: $(wc -l < requirements.txt) ì¤„"
        else
          echo "âŒ ë£¨íŠ¸ì— requirements.txt ì—†ìŒ"
        fi
        echo ""
        echo "ğŸ“„ Django requirements.txt íŒŒì¼ í™•ì¸:"
        if [ -f "hearth_chat_django/requirements.txt" ]; then
          echo "âœ… Django í´ë”ì— requirements.txt ì¡´ì¬"
        else
          echo "âŒ Django í´ë”ì— requirements.txt ì—†ìŒ"
        fi
        echo ""
        echo "ğŸ“„ React package.json íŒŒì¼ í™•ì¸:"
        if [ -f "hearth_chat_react/package.json" ]; then
          echo "âœ… React í´ë”ì— package.json ì¡´ì¬"
        else
          echo "âŒ React í´ë”ì— package.json ì—†ìŒ"
        fi
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: hearth_chat_react/package-lock.json
        
    - name: Install Python dependencies
      run: |
        echo "ğŸ Python ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
        echo "=========================="
        
        # ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ requirements.txt ì‚¬ìš©
        if [ -f "requirements.txt" ]; then
          echo "âœ… ë£¨íŠ¸ requirements.txt ì‚¬ìš©"
          pip install -r requirements.txt
        elif [ -f "hearth_chat_django/requirements.txt" ]; then
          echo "âœ… Django í´ë” requirements.txt ì‚¬ìš©"
          pip install -r hearth_chat_django/requirements.txt
        else
          echo "âŒ requirements.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          echo "ì‚¬ìš© ê°€ëŠ¥í•œ requirements íŒŒì¼ë“¤:"
          find . -name "requirements*.txt" -type f
          exit 1
        fi
        
        echo "âœ… Python ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
        
    - name: Install Node.js dependencies
      run: |
        echo "ğŸ“¦ Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘"
        echo "============================"
        
        if [ -f "hearth_chat_react/package.json" ]; then
          cd hearth_chat_react
          npm ci
          cd ..
          echo "âœ… Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
        else
          echo "âŒ package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          exit 1
        fi
        
    - name: Build React app
      run: |
        echo "ğŸ”¨ React ì•± ë¹Œë“œ ì‹œì‘"
        echo "======================"
        
        if [ -f "hearth_chat_react/package.json" ]; then
          cd hearth_chat_react
          
          # CI ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
          if [ -f "build-ci.sh" ]; then
            echo "ğŸ“œ CI ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©"
            chmod +x build-ci.sh
            ./build-ci.sh
          else
            echo "ğŸ“œ ê¸°ë³¸ ë¹Œë“œ ì‚¬ìš© (CI=false)"
            CI=false npm run build
          fi
          
          cd ..
          echo "âœ… React ë¹Œë“œ ì™„ë£Œ"
        else
          echo "âŒ package.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          exit 1
        fi
        
    - name: Check Django setup
      run: |
        echo "ğŸ§ª Django ì„¤ì • í™•ì¸"
        echo "===================="
        
        if [ -f "hearth_chat_django/manage.py" ]; then
          cd hearth_chat_django
          
          # Django ì„¤ì • í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "check-django.py" ]; then
            echo "ğŸ“œ Django ì„¤ì • í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
            chmod +x check-django.py
            python check-django.py
          else
            echo "ğŸ“œ ê¸°ë³¸ Django ì„¤ì • í™•ì¸"
            # ê°„ë‹¨í•œ Django ê°€ì ¸ì˜¤ê¸° í…ŒìŠ¤íŠ¸ (í•œ ì¤„ë¡œ ì²˜ë¦¬)
            python -c "import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'hearth_chat.settings'); os.environ['DATABASE_URL'] = 'sqlite:///test.db'; os.environ['DEBUG'] = 'True'; os.environ['SECRET_KEY'] = 'test-secret-key'; import django; django.setup(); print('âœ… Django ê¸°ë³¸ ì„¤ì • ë¡œë“œ ì„±ê³µ')" || echo "âš ï¸ Django ì„¤ì • ë¡œë“œ ì‹¤íŒ¨í•˜ì§€ë§Œ ë°°í¬ëŠ” ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤."
          fi
          
          cd ..
          echo "âœ… Django ì„¤ì • í™•ì¸ ì™„ë£Œ"
        else
          echo "âŒ manage.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          echo "âš ï¸ Django ì„¤ì • í™•ì¸ì„ ê±´ë„ˆëœë‹ˆë‹¤."
        fi
        
    - name: Deploy to Render via API
      run: |
        echo "ğŸš€ Render APIë¥¼ í†µí•œ ë°°í¬ ì‹œì‘!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Force rebuild: ${{ github.event.inputs.force_rebuild }}"
        echo ""
        
        # Render Deploy Hook í˜¸ì¶œ
        if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
          echo "ğŸ”„ ê°•ì œ ì¬ë¹Œë“œ ëª¨ë“œë¡œ ë°°í¬ ì¤‘..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"force": true}' \
            -w "\nHTTP Status: %{http_code}\n"
        else
          echo "ğŸ“¦ ì¼ë°˜ ë°°í¬ ëª¨ë“œë¡œ ë°°í¬ ì¤‘..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"
        fi
        
        echo ""
        echo "âœ… Render ë°°í¬ ìš”ì²­ ì™„ë£Œ!"
        echo "ğŸ“Š ë°°í¬ ìƒíƒœëŠ” Render ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”:"
        echo "   https://dashboard.render.com"
        
    - name: Wait for deployment (optional)
      if: github.event.inputs.environment == 'production'
      run: |
        echo "â³ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        echo "ì¼ë°˜ì ìœ¼ë¡œ 2-5ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤."
        echo "Render ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”."
        
    - name: Deployment Summary
      run: |
        echo ""
        echo "ğŸ‰ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"
        echo "=================================="
        echo "ğŸ“‹ ë°°í¬ ìš”ì•½:"
        echo "   â€¢ í™˜ê²½: ${{ github.event.inputs.environment }}"
        echo "   â€¢ ê°•ì œ ì¬ë¹Œë“œ: ${{ github.event.inputs.force_rebuild }}"
        echo "   â€¢ ì»¤ë°‹: ${{ github.sha }}"
        echo "   â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "   â€¢ ì‹¤í–‰ì: ${{ github.actor }}"
        echo ""
        echo "ğŸ”— ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”:"
        echo "   â€¢ Render ëŒ€ì‹œë³´ë“œ: https://dashboard.render.com"
        echo "   â€¢ GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ’¡ ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¡œë§Œ ì‹¤í–‰ë˜ì–´ ë Œë” ë¬´ë£Œ ë¶„ëŸ‰ì„ ì ˆì•½í•©ë‹ˆë‹¤." 