name: Test Deploy to Render

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: false
        default: 'simple'
        type: choice
        options:
        - simple
        - full

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Render Hook
      run: |
        echo "ğŸ§ª Render Deploy Hook í…ŒìŠ¤íŠ¸ ì‹œì‘"
        echo "=================================="
        
        # 1. ê¸°ë³¸ ì •ë³´ ì¶œë ¥
        echo "GitHub Actor: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        
        # 2. RENDER_DEPLOY_HOOK ê°’ í™•ì¸ (ë§ˆìŠ¤í‚¹ë¨)
        if [ -n "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
          echo "âœ… RENDER_DEPLOY_HOOK ì„¤ì •ë¨"
          echo "URL ê¸¸ì´: ${#RENDER_DEPLOY_HOOK} ë¬¸ì"
          
          # URL í˜•ì‹ ê²€ì¦
          if [[ "${{ secrets.RENDER_DEPLOY_HOOK }}" =~ ^https://api\.render\.com/deploy/srv-[a-zA-Z0-9]+ ]]; then
            echo "âœ… URL í˜•ì‹ì´ ì˜¬ë°”ë¦„"
          else
            echo "âŒ URL í˜•ì‹ì´ ì˜ëª»ë¨"
          fi
        else
          echo "âŒ RENDER_DEPLOY_HOOKì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          exit 1
        fi
        
        echo ""
        
        # 3. ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ë°°í¬ëŠ” í•˜ì§€ ì•ŠìŒ)
        if [ "${{ github.event.inputs.test_mode }}" = "full" ]; then
          echo "ğŸ”„ ì „ì²´ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: Render API í˜¸ì¶œ ì‹œë„"
          
          # í—¤ë”ë§Œ í™•ì¸ (ì‹¤ì œ ë°°í¬ëŠ” í•˜ì§€ ì•ŠìŒ)
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"test": true}' \
            --max-time 10)
          
          echo "HTTP ì‘ë‹µ ì½”ë“œ: $response"
          
          if [ "$response" = "200" ] || [ "$response" = "202" ]; then
            echo "âœ… Render API ì‘ë‹µ ì„±ê³µ"
          else
            echo "âŒ Render API ì‘ë‹µ ì‹¤íŒ¨: $response"
            echo "âš ï¸ ì‹¤ì œ ë°°í¬ëŠ” í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)"
          fi
        else
          echo "ğŸ“‹ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì„¤ì •ë§Œ í™•ì¸"
        fi
        
        echo ""
        echo "ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
        
    - name: Test Summary
      run: |
        echo ""
        echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ìš”ì•½"
        echo "=============="
        echo "âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"
        echo "âœ… RENDER_DEPLOY_HOOK ì„¤ì • í™•ì¸"
        echo "âœ… ê¸°ë³¸ í™˜ê²½ ë³€ìˆ˜ í™•ì¸"
        if [ "${{ github.event.inputs.test_mode }}" = "full" ]; then
          echo "âœ… Render API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        fi
        echo ""
        echo "ğŸ’¡ ì´ì œ ì‹¤ì œ ë°°í¬ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•´ë³´ì„¸ìš”!" 