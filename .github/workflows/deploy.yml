name: Manual Deploy to Render

on:
  # ìë™ íŠ¸ë¦¬ê±° ë¹„í™œì„±í™”
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë§Œ í™œì„±í™”
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: hearth_chat_react/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd hearth_chat_django
        pip install -r requirements.txt
        
    - name: Install Node.js dependencies
      run: |
        cd hearth_chat_react
        npm ci
        
    - name: Build React app
      run: |
        cd hearth_chat_react
        npm run build
        echo "React build completed"
        
    - name: Run tests (optional)
      run: |
        cd hearth_chat_django
        python manage.py test --verbosity=2
        
    - name: Deploy to Render via API
      run: |
        echo "ğŸš€ Render APIë¥¼ í†µí•œ ë°°í¬ ì‹œì‘!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Force rebuild: ${{ github.event.inputs.force_rebuild }}"
        echo ""
        
        # Render Deploy Hook í˜¸ì¶œ
        if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
          echo "ğŸ”„ ê°•ì œ ì¬ë¹Œë“œ ëª¨ë“œë¡œ ë°°í¬ ì¤‘..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"force": true}' \
            -w "\nHTTP Status: %{http_code}\n"
        else
          echo "ğŸ“¦ ì¼ë°˜ ë°°í¬ ëª¨ë“œë¡œ ë°°í¬ ì¤‘..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"
        fi
        
        echo ""
        echo "âœ… Render ë°°í¬ ìš”ì²­ ì™„ë£Œ!"
        echo "ğŸ“Š ë°°í¬ ìƒíƒœëŠ” Render ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”:"
        echo "   https://dashboard.render.com"
        
    - name: Wait for deployment (optional)
      if: github.event.inputs.environment == 'production'
      run: |
        echo "â³ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        echo "ì¼ë°˜ì ìœ¼ë¡œ 2-5ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤."
        echo "Render ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”."
        
    - name: Deployment Summary
      run: |
        echo ""
        echo "ğŸ‰ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"
        echo "=================================="
        echo "ğŸ“‹ ë°°í¬ ìš”ì•½:"
        echo "   â€¢ í™˜ê²½: ${{ github.event.inputs.environment }}"
        echo "   â€¢ ê°•ì œ ì¬ë¹Œë“œ: ${{ github.event.inputs.force_rebuild }}"
        echo "   â€¢ ì»¤ë°‹: ${{ github.sha }}"
        echo "   â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "   â€¢ ì‹¤í–‰ì: ${{ github.actor }}"
        echo ""
        echo "ğŸ”— ë‹¤ìŒ ë§í¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”:"
        echo "   â€¢ Render ëŒ€ì‹œë³´ë“œ: https://dashboard.render.com"
        echo "   â€¢ GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ’¡ ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¡œë§Œ ì‹¤í–‰ë˜ì–´ ë Œë” ë¬´ë£Œ ë¶„ëŸ‰ì„ ì ˆì•½í•©ë‹ˆë‹¤." 